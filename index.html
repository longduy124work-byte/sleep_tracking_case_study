<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Tracker App</title>
    <!--Bootstrap CSS-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet">

    <script src="script.js"></script>
</head>

<body>
    <!--Modal-->
    <div class="modal" tabindex="-1" id="bedtime-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cập nhật giờ ngủ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <lable class="fs-6" for="bed-time">Input your bed time</lable> <br>
                    <input id="bed-time" type="time"> <br>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="save()">Save
                        changes</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" tabindex="-1" id="wakeup-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fs-4">Cập nhật giờ dậy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <lable for="wakeup-time">Input your wake up time</lable> <br>
                    <input id="wakeup-time" type="time"> <br>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="save()">Save
                        changes</button>
                </div>
            </div>
        </div>
    </div>
    <!--Nội dung-->
    <div class="text-center mb-3">
        <h1>Basic Sleep Tracker</h1>
    </div>
    <div id="all-week-quality"></div>
    <div class="mt-4 mb-4 d-flex gap-2 my-3" id="fullWeek"></div>
    <div id="detail"></div>
    <div id="totalHour"></div>
    <script>

        // Hàm sinh ra các ngày trong tháng
        // function generateDaysOfMonth() {
        //     let result = [];
        //     let now = new Date();
        //     let month = now.getMonth();
        //     let year = now.getFullYear();

        //     // tính số ngày trong tháng -> phục vụ vòng lặp
        //     let daysInMonth = new Date(year, month+1, 0).getDate(); //ngày cuối cùng của tháng hiện tại
        //     let weekDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        //     //thay cho thuộc tính id của code cũ
        //     let idCount = 1;

        //     for(let day=1; day <= daysInMonth; day++) {
        //         let dateObj = new Date(year, month, day);
        //         let weekDayName = weekDays[dateObj.getDay()]; // thuộc tính day trong biến cũ
        //         let dateString = `${day}-${month+1}-${year}`;

        //         // tạo object từ class SleepDate
        //         let sleepDate = new SleepDate(idCount, weekDayName, dateString);

        //         result.push(sleepDate); //thay cho mảng days cũ
        //         idCount++

        //     }

        //     return result;
        // }

        //Hàm xác định được thứ 2 trong tuần là ngày bao nhiêu
        function getMonday() {
            let today = new Date();
            let dayOfWeek = today.getDay(); //0-6

            let diff = null;
            if (dayOfWeek === 0) {
                diff = -6;
            } else {
                diff = 1 - dayOfWeek;
            }

            today.setDate(today.getDate() + diff);
            return today;
        }

        //hàm sinh ra cả tuần
        function generateWeek() {
            let days = [];
            let monday = getMonday() //biết được ngày của thứ 2 sẽ tính được ra ngày của cả tuần

            for (let i = 0; i < 7; i++) {
                let dateObj = new Date(monday); //clone ra 1 thứ 2 trong vòng lặp, không trỏ đến cùng biến monday
                dateObj.setDate(dateObj.getDate() + i)

                let id = i + 1;
                let dayName = dateObj.toLocaleDateString("en-US", { weekday: "short" }); //Mon, Tue...
                let dayString = dateObj.getDate() + "-" + dateObj.getMonth() + "-" + dateObj.getFullYear();

                let sleepDay = new SleepDate(id, dayName, dayString);
                days.push(sleepDay);
            }
            return days
        }

        let days = generateWeek();

        // Đối tượng SleepOverall
        let allWeekSleep = new SleepOverall()
        // Tính tổng giấc ngủ trong tuần
        allWeekSleep.calWeekTotalSleep(days);
        function displayAllWeekQuality() {
            let quality = allWeekSleep.getWeekTotalSleep();
            document.getElementById("all-week-quality").innerHTML = quality;
        }
        displayAllWeekQuality();

        // nhận biết ngày nào đang được chọn
        let currentEditingDayId = null;


        function displayDate() {
            let str = ""
            for (let i = 0; i < days.length; i++) {
                str += `<div class="shadow-sm day-item" data-day-id="${days[i].id}" onclick="handleDayClick(${days[i].id}, this)">
                            ${days[i].getFullDay()}
                         </div>`;
            }

            document.getElementById("fullWeek").innerHTML = str;
        }
        displayDate();

        //cell đang được click
        let currentActiveCell = null;
        function handleDayClick(dayId, cell) {
            // click sang td khác thì mất màu
            if (currentActiveCell !== null) {
                currentActiveCell.classList.remove("active-day");
            }
            //highlight vào ngày được click
            cell.classList.add("active-day");

            // lưu lại ngày đang được click
            currentActiveCell = cell;

            displayDetail(dayId);
        }

        function displayDetail(id) {
            let day = getDayById(id);
            currentEditingDayId = id;
            let detailRecord = day.getFullTime();
            let totalHour = day.getTotalHours();
            document.getElementById("detail").innerHTML = detailRecord;
            document.getElementById("totalHour").innerHTML = totalHour;
        }

        function getDayById(id) {
            for (let i = 0; i < days.length; i++) {
                if (days[i].id === id) {
                    return days[i];
                }
            }
            return null;
        }

        // tự chọn hiển thị ngày real time
        function autoSelectDay() {
            let today = new Date();
            let todayDate = today.getDate();

            for (let i = 0; i < days.length; i++) {
                let dateParts = days[i].date.split("-"); //lấy ngày từ thuộc tính date, tách ngày bằng split
                let dayOfMonth = parseInt(dateParts[0]);

                if (dayOfMonth === todayDate) {
                    // tìm được td cần hiển thị
                    let td = document.querySelector(`div[data-day-id="${days[i].id}"]`)

                    if (td) {
                        handleDayClick(days[i].id, td)
                    }
                    break;
                }
            }

        }
        displayDate();
        autoSelectDay();

        function save() {
            let bedTimeInput = document.getElementById("bed-time").value;
            let wakeupTimeInput = document.getElementById("wakeup-time").value;
            let day = getDayById(currentEditingDayId);
            day.updateSleepTime(bedTimeInput, wakeupTimeInput);
            // chỉ update nếu user có nhập
            if (bedTimeInput !== "") {
                day.bedTime = bedTimeInput;
            }

            if (wakeupTimeInput !== "") {
                day.wakeupTime = wakeupTimeInput;
            }

            displayDetail(currentEditingDayId);

            //cập nhật lại tổng giờ ngủ cả tuần
            allWeekSleep.calWeekTotalSleep(days);
            displayAllWeekQuality();
        }

    </script>
    <!--Bootstrap JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
</body>

</html>